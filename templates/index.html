<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>PDV Barbearia</title>
<link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
<script src="{{ url_for('static', filename='script.js') }}" defer></script>
</head>
<body>

<div class="container">

<h1>ðŸ’ˆ Venda Inteligente</h1>

{% if not aberto %}
<form method="POST" action="/abrir_caixa">
    <input name="saldo" placeholder="Saldo inicial">
    <button>Abrir Caixa</button>
</form>
{% endif %}

<form method="POST" action="/venda" class="box">

<select name="tipo" id="tipo" onchange="carregarItens()">
    <option value="">Tipo</option>
    <option value="servico">ServiÃ§o</option>
    <option value="produto">Produto</option>
</select>

<select name="item" id="item" onchange="buscarPreco()"></select>

<input id="valor" placeholder="Valor" disabled>

<select name="pagamento" id="pagamento" onchange="troco()">
    <option>Dinheiro</option>
    <option>Pix</option>
    <option>CartÃ£o</option>
</select>

<input id="recebido" placeholder="Recebido" onkeyup="troco()">
<p id="troco"></p>

<button>Finalizar Venda</button>
</form>

</div>

<script>
const servicos = {{ servicos|tojson }};
const produtos = {{ produtos|tojson }};

function carregarItens(){
    const tipo = document.getElementById("tipo").value;
    const item = document.getElementById("item");
    item.innerHTML = "";

    const lista = tipo === "servico" ? servicos : produtos;

    lista.forEach(i => {
        const opt = document.createElement("option");
        opt.value = i[0];
        opt.text = i[1];
        item.appendChild(opt);
    });

    buscarPreco();
}

function buscarPreco(){
    const tipo = document.getElementById("tipo").value;
    const id = document.getElementById("item").value;
    fetch(`/preco/${tipo}/${id}`)
        .then(r => r.json())
        .then(p => document.getElementById("valor").value = "R$ " + p.toFixed(2));
}

function troco(){
    const pagamento = document.getElementById("pagamento").value;
    const recebido = parseFloat(document.getElementById("recebido").value || 0);
    const valor = parseFloat(
        document.getElementById("valor").value.replace("R$","") || 0
    );

    document.getElementById("troco").innerText =
        pagamento === "Dinheiro" && recebido >= valor
        ? "Troco: R$ " + (recebido - valor).toFixed(2)
        : "";
}
</script>

</body>
</html>
